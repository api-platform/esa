<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Linked Data</title>
  <script type="importmap">
    {
      "imports": {
        "urlpattern-polyfill": "https://esm.sh/urlpattern-polyfill@10.0.0",
        "@api-platform/ld": "./ld.js"
      }
    }
  </script>
</head>

<body>
  <ul id="list">
  </ul>
  <script type="module">
    import ld from "@api-platform/ld";
    import {URLPattern} from "urlpattern-polyfill";
    // todo: use polyfill https://github.com/kenchris/urlpattern-polyfill
    const pattern = new URLPattern("/authors/:id", window.origin);
    const list = document.getElementById('list')

    function onUpdate(books) {
      books['hydra:member'].forEach((book, i) => {
        // Emulate loading time with a random timeout
        const delay = (i + 1) * Math.floor(Math.random() * (750 - 250) + 250);
        setTimeout(() => {
          const li = list.querySelector(`[data-bookid="${book['@id']}"]`);
          if (!li) {
            console.error(`Could not find list item with book id ${book['@id']}!`);
            return;
          }
          li.innerText = `${book.title} - ${book.author?.name}`
        }, delay);
      });
    }

    ld('/books', {urlPattern: pattern, onUpdate})
      .then((books) => {
        books['hydra:member'].forEach((book) => {
          const li = document.createElement('li')
          li.setAttribute('data-bookid', book['@id']);
          li.dataset.testid = 'book'
          li.innerText = `${book.title} - ${book.author?.name || '(â€¦)'}`
          list.appendChild(li)
        });
      })
  </script>
</body>
